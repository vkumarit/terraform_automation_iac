trigger:
- main

pool:
  name: 'az-classic-pool'  # EC2 self-hosted agent pool

variables:
  serviceConnection: 'az-classic-conn'  # Azure RM service connection
  storageAccountRg: 'myTFResourceGroup'
  storageAccountName: 'prodmyapptfstate01'
  containerName: 'mytfstate'
  key: 'terraform.tfstate'
  resourceGroup: 'myTFResourceGroup'

stages:
- stage: Plan
  jobs:
  - job: Plan
    steps:
    - task: TerraformInstaller@0
      inputs:
        terraformVersion: '1.14.3'  # Match version

    - task: TerraformTaskV4@4  # Or V2/V3 based on marketplace
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroup: '$(storageAccountRg)'
        backendAzureRmStorageAccount: '$(storageAccountName)'
        backendAzureRmContainerName: '$(containerName)'
        backendAzureRmKey: '$(key)'
        environmentServiceNameAzureRM: '$(serviceConnection)'

    - task: TerraformTaskV4@4
      inputs:
        provider: 'azurerm'
        command: 'plan'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        commandOptions: '-out=tfplan'

- stage: Apply
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - job: Apply
    steps:
    - task: TerraformInstaller@0  # Reinstall for consistency

    - task: TerraformTaskV4@4
      inputs:
        provider: 'azurerm'
        command: 'init'
        backendServiceArm: '$(serviceConnection)'
        backendAzureRmResourceGroup: '$(storageAccountRg)'
        backendAzureRmStorageAccount: '$(storageAccountName)'
        backendAzureRmContainerName: '$(containerName)'
        backendAzureRmKey: '$(key)'
        environmentServiceNameAzureRM: '$(serviceConnection)'

    - task: TerraformTaskV4@4
      inputs:
        provider: 'azurerm'
        command: 'apply'
        environmentServiceNameAzureRM: '$(serviceConnection)'
        commandOptions: 'tfplan'
